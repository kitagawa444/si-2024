\section{三次元点群を利用した自己位置推定}
\label{sec:self_position}
　既存のSLAM技術\cite{6DSLAM_outside, 3D_SLAM_outside, EKF_SLAM, FAST-LIO, FAST-LIO2}を点群マッチングによる原点補正を加え拡張することで，既知環境における汎用でロバストな自己位置推定技術の確立を目的とする．

\subsection{三次元SLAM}
　工場内での自己位置推定に点群マッチングと三次元SLAMを併用するメリットとして大きく３つ挙げられる．
まずはじめに，車輪オドメトリを使わない点が挙げられる．工場の路面環境は比較的つるつるとしている上に，所々大きな段差が見られる．そのため，ロータリエンコーダを用いた車輪オドメトリを利用すると，移動時の空転の影響を受けやすく，安定しない．同様にIMUを利用したオドメトリも誤差が大きく安定しない．その点3D LiDARを利用するオドメトリは誤差も小さく，カルマンフィルタから計算される自己位置もより正確である．次に，環境変化に強いことが挙げられる．3D-AMCL\cite{3d-AMCL}と比較すると，3D-SLAM内では既知マップを利用しないため，後述の原点補正と組み合わせても，環境変化影響度が低い．環境変化が頻繁におこる工場などの環境では，SLAMを利用すると，その都度点群取得できるため，変化に対応しやすい．最後にSLAM単体で自己位置推定を完結することができる点が挙げられる．特に，AMCLは推定の収束性に問題が生じやすい上，高周期で実行できないため，工場環境で障害物や運搬物などがある状況下では単体で機能しづらいことが考えられる．一方で，SLAMは後述の原点補正が環境変化や障害物などで，十分に機能しなくなったときや計算時間が増大し遅延が発生する場合も独立で機能するため，正確でロバストな自己位置推定が実現できる．
以上の点からSLAMと点群マッチングを組み合わせた拡張3D-SLAMを利用する．

\subsection{点群マッチングによる原点補正}
　前節のSLAM技術により作成された三次元点群による環境地図と3D LiDARから得られる点群情報を利用して，SLAMの原点と環境地図における原点との相対関係を算出することで原点を補正する．環境地図とLiDARからの点群にIterative Closest Point (ICP)\cite{ICP}を適用することにより，点群のマッチングを行い，相互の原点の相対関係を算出する．ICPとは2つの点群同士の位置合わせを繰り返し計算によって実現する手法である．

Fig.~\ref{fig:fig2}に本アルゴリズムを適用した結果を示しており，赤色の点群が環境地図の点群を表しており，白色の点群が3D LiDARから得られている点群を表している．ICPの適用により，環境地図の点群と3D LiDARの点群が重なり合っていることが確認できる．

\section{経路計画・追従制御手法}
\label{sec:control}
　ロボットの効率的な自律移動および停止時における高精度な位置制御を実現するために，Fig.~\ref{fig:fig3}のような目標位置までの距離によってことなるアプローチをとる自律走行システムを構築した．

\begin{figure}[!t]
\includegraphics[width=\columnwidth]{figs/3.pdf}
\caption{Conceptual scheme of autonomous moving system}
\label{fig:fig3}
\end{figure}

\begin{figure}[!t]
\includegraphics[width=\columnwidth]{figs/4.pdf}
\caption{System architecture}
\label{fig:fig4}
\end{figure}

\subsection{二次元平面での経路計画と追従}
　目標位置の遠方では大域的，局所的，２つの経路計画を組み合わせて決定することによって，目的地への最適な経路を計画し，実行中の状況変化に柔軟に対応できるロバストな経路計画手法を構築した．

まず，ロボットは現在の位置と目標地点をもとに，大局的な経路計画を立てる．この経路計画は，事前に得られている環境の地図を元にしながら，最も効率的なルートを選び出すものであり，この経路計画アルゴリズムにはダイクストラアルゴリズム\cite{dijkstra}を利用した．ダイクストラアルゴリズムは，始点から各ノードへの距離を初期化し，優先度キューを使って距離が最小のノードから隣接ノードへの距離を更新していき，これを繰り返すことで，すべてのノードに対して最短距離を求めることのできるアルゴリズムである．ダイクストラ法はシンプルな経路探索において広く使われており，事前地図が定義されている場合に非常に有効な手段といえる．
しかし，現実の環境では，計画段階では予測できない障害物や環境変化による移動の妨げが生じることが考えられる．そこで，センサーによるリアルタイム情報を使って，障害物を検知し，その場で経路を柔軟に修正する必要がある．この局所的な経路探索にはDWA(Dynamic Window Approach)\cite{DWA}を用いる．DWAはロボットの物理的な運動制約を基に一連の候補となる動作を生成し，その中から最適なものを選択するアルゴリズムである．ロボットの位置周辺における移動リスクを定量化し，静的な構造物だけでなく，移動中の障害物にも柔軟に対応することができる．このようにして，ロボットは大域的な計画を維持しながらも，周囲の環境変化に適応して進むことができる．


\subsection{終端位置姿勢制御}
\label{subsec:pos_control}
　目標位置の近傍では，次の式で表されるP制御を用いてロボットの位置姿勢制御を行った．この制御により目標位置及び目標姿勢に追従する．
\begin{align}
v^{\text{des}} &= K_{P_{r}} e_{r}
\end{align}
\begin{align}
w^{\text{des}} &= K_{P_{θ}} e_{θ}
\end{align}

\section{システムアーキテクチャ}
　本システムの概要をFig.~\ref{fig:fig4}に示す．
本システムではハードウェアとして，移動台車ロボットとその台車を制御する制御基板，センサーとして3D LiDAR，\ref{sec:self_position}, \ref{sec:control}の自己位置推定と目標位置追従制御をオンラインで実行するためのOnboard PCを使用する．

本システムでは，事前の地図作成プロセスとオンラインの自律移動プロセスの２つに分けられる．

まず，事前プロセスとして，State Estimator内のSLAM技術を用いて，環境マップを作成する．これにより，三次元の環境地図を作成し，三次元の環境地図を特定の高さ範囲で区切ることで，二次元環境地図を作成する．この２つの環境地図を組み合わせて，オンラインプロセスを実行する．

オンラインプロセスではState EstimatorとMotion Planner and Position Controllerの２つを用いて自律移動を実現する．State Estimatorでは前述の三次元地図とLiDARのセンサ情報を利用して，高精度な自己位置推定を行う．Motion Planner and Position ControllerではState Estimatorからオドメトリ情報，3D LiDARで得られる点群情報を特定の高さ範囲で区切ることで得られる2次元点群情報，ユーザーから指定される経由点と目標点，を受け取り台車ロボットの制御基板に目標速度を渡す．

上記の２つのプロセスにより，目標位置にロバストで高精度に追従することのできるシステムを構築した．
本システムでは台車ロボットを速度により制御することができ，経由点と目標点をユーザーが自由に設定することができる．また，自己位置推定や経路計画の実時間性を保つためにすべてのプロセスをOnboardPC内で実行しており，全体の自律性を実現する．

\begin{table}[!t]
    \caption{Points in experiment}
    \label{table1}
    \centering
    \begin{tabular}{cccc} \hline
      Points & x[m] & y[m] & θ[deg]\\
      \hline \hline
      Point1 & -0.1 & -0.01 & 0\\
      Point2 & 1.29 & 1.46 & 0, 180\\
      Point3 & 7.25 & 1.37 & 0, 180\\
      Point4 & 15.36 & -1.87 & 180\\
      \hline
    \end{tabular}
\end{table}

\begin{figure}[!t]
\includegraphics[width=\columnwidth]{figs/6.pdf}
\caption{Pass and goal point in experiment and process of the precise approach}
\label{fig:fig6}
\end{figure}

\begin{figure}[!t]
\includegraphics[width=\columnwidth]{figs/7.pdf}
\caption{Trajectory of the robot in the experiment}
\label{fig:fig7}
\end{figure}

\section{実験}

\subsection{プラットフォーム}
　本システムの開発にはロボット用のミドルウェアとして広く利用されているROS(Robot Operating System)を利用し，State Estimator, Motion Planner and Position Controllerの処理に活用された．
Onboard PCとして，Khadas社製Vim4(KVIM4-B-001)，3D LiDARとしてLivox社製Mid-360，地上ロボットにはヴィンストン社製メカナムホイール全方位移動台車ロボット メカナムローバー ver3.0を用いた．また，台車ロボットには実験のためにペンホルダーを左右に増設した．

\subsection{実験手法}
　本実験では\ref{sec:self_position}, \ref{sec:control}で述べた自己位置推定及び，位置姿勢追従制御の正確性を検証した．工場における運用を考え始点，終点，中継地点2つの合計4点を目的の姿勢で通過する往復走行を10回おこなった．Fig.~\ref{fig:fig2}に示すように，走行車両の両側にはペンを固定し，床面に軌跡を描くことで，得られた軌跡からPoint1,Point4におけるロボットの停止精度を分析した．Point1〜4の位置は二次元マップ上で，Table.~\ref{table1}のように設定した．
また，自律走行システムの適応性や安全性を評価するために主に次の３つのシチュエーションにおける台車ロボットの挙動を評価した．
\begin{enumerate}[label=(\alph*)]
  \item 幅，高さが非常に狭い区間における走行
  \item 事前作成の地図上にはない静的障害物
  \item 動的障害物をロボットの進路上に急に置いた場合
\end{enumerate}
本実験はトヨタ自動車株式会社本社工場で実施された． 

\begin{table}[!t]
    \caption{Average point and orientation of center of robot}
    \label{table2}
    \centering
    \begin{tabular}{cccc} \hline
      Points & x[mm] & y[mm] & θ[deg]\\
     \hline \hline
      Point1 & 14.8 & 11.2 & -0.08\\
      Point4 & 63.6 & -12.8 & -0.01\\
      \hline
    \end{tabular}
\end{table}

\begin{figure}[!t]
\includegraphics[width=\columnwidth]{figs/8.pdf}
\caption{Robot stopping positon at Point1}
\label{fig:fig8}
\end{figure}

\begin{figure}[!t]
\includegraphics[width=\columnwidth]{figs/9.pdf}
\caption{Robot stopping positon at Point4}
\label{fig:fig9}
\end{figure}

\subsection{実験結果}
　実験により得られた，ロボットの軌跡をFig.~\ref{fig:fig7}に示す．Point1,4で得られた10回の軌跡のうち，判別可能なもの(Point1では8つ，Point4では6つ)を抽出し，それぞれにおけるロボットの重心と向きを，床のシートの中心を(0,0)として，写真水平右方向をx軸正方向，鉛直上方向をy軸正方向として，Fig.~\ref{fig:fig8}，Fig.~\ref{fig:fig9}を作成した．また，平均の重心の位置と姿勢をTable.~\ref{table2}に示す．

また，(a)〜(c)の様子をFig.~\ref{fig:fig10}に示す．(a)〜(c)のどのシチュエーションに置いても障害物にぶつかることなく安全に移動することができた．

\begin{figure}[!t]
\includegraphics[width=\columnwidth]{figs/10.pdf}
\caption{(a) Driving in sections with very narrow width and height. (b)Puting static obstacle not on the pre-made map. (c) Static obstacle not on the pre-made map.}
\label{fig:fig10}
\end{figure}

\subsection{考察}
平均の重心位置と姿勢からPoint1ではPoint4と比較して，X軸正方向に60mmと大きくずれていることが確認できる．これは，\ref{sec:self_position}のうちSLAMにおける位置推定誤差が影響していると考えられ，台車のyaw角が180度変わると誤差が積算されることが示唆される．これを裏付けるように，Point2,3の復路では往路と比較して，x軸方向にPoint4と同様のx軸正方向のズレが確認された．しかしながら，繰り返し誤差は9〜15mmであり，非常に高精度であると考えられる．このように，台車の姿勢によって恒常的なオフセットが発生していることから，幾何的な変換時の誤差であることも考えられる．

一方で，Point4のほうがPoint1と比較して角度の誤差が大きいことが確認できる．これは，\ref{subsec:pos_control}で発生した定常誤差であることを考えられ，収束判定の見直しやI制御を追加することで軽減することができると考えられる．

また，本自律走行システムのロバスト性が非常に高いことがFig.~\ref{fig:fig10}から示唆される．とくに(a),幅，高さが非常に狭い区間における走行では，高い自己位置推定精度とLiDARによる障害物検知から，ロボットが走行可能な範囲を正確に認識し，ロボットの幅+約10cmのような非常に狭い隙間も衝突なく走行することができた．加えて，(c),動的障害物をロボットの進路上に急に置いた場合にも，ロボットの経路計画及び速度制御を高周期で実行しているため，突発的な障害物の出現に対して，容易に回避行動を取ることができた．
しかしながら，例えば,突然台車の前方足元に小型の障害物が出現する場合，台車の前方で低い位置にある障害物は3D LiDARの点群取得範囲（本製品は水平方向から±60°）からはずれているため，検知することができず衝突する可能性が考えられる．そのため，LiDARの取り付け位置，角度や複数台取り付けるなどすることにより，地表近くでの状態変化にも対応することができるようになると考えられる．
